<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>我的应用</title>
<link rel="stylesheet" href="themes/health.min.css" />
<link rel="stylesheet" href="themes/jquery.mobile.icons.min.css" />
<link rel="stylesheet" href="themes/jquery.mobile.structure-1.4.3.min.css" />
<script src="themes/js/jquery-1.11.1.min.js"></script>
<script src="themes/js/jquery.mobile-1.4.3.min.js"></script>
<script src="themes/js/jquery.json.min.js"></script>
<script src="themes/js/xuhm.js"></script>
<script src="themes/js/xuhm_ext.js"></script>
<script>
	$(function(){
		$("[data-role='navbar']").navbar();
		$("[data-role='header'], [data-role='footer']").toolbar();
	});
	$(document).delegate("#page-content", "pageinit", function() {

	});
</script>
</head>
<body>
<div data-role="header" data-position="fixed" data-theme="a">
  <h1></h1>
</div>
<!-- /header -->
<div data-role="page" class="health-page">
	<div class="ui-content jqm-content jqm-fullwidth" role="main" id="page-content">
        <div id="user_panel" style="display:none;">
            <div class="ui-field-contain">
                <label for="user_realname">真实姓名:</label>
                <input readonly="readonly" type="text" name="user_realname" id="user_realname" placeholder="真实姓名" value="">
            </div>
            <div class="ui-field-contain">
                <label for="user_score">用户积分:</label>
                <input readonly="readonly" type="text" name="user_score" id="user_score" placeholder="用户积分" value="">
            </div>
            <div data-role="collapsible">
                <h4>积分转移</h4>
                <p>
                    <label for="textinput-hide" class="ui-hidden-accessible">转移对象用户名:</label>
                    <input type="text" name="transfer_user_name" id="transfer_user_name" placeholder="转移对象用户名" value="">
                    <label for="slider">转移积分数:</label>
                    <input type="range" name="transfer_user_score" id="transfer_user_score" value="10" min="0" max="1000">
                    <a href="#" onClick="transfer_score();" class="ui-shadow ui-btn ui-corner-all ui-btn-inline ui-btn-icon-left ui-icon-star">确认转移</a>
                </p>
            </div>
            <a href="#" onClick="logout();" data-rel="popup" data-position-to="window" data-role="button" data-inline="true" aria-haspopup="true" aria-owns="popupLogin" aria-expanded="false" class="ui-link ui-btn ui-btn-inline ui-shadow ui-corner-all" role="button">注销退出</a>
        </div>
        <div id="user_popuplogin" style="display:show;">
			<a href="#popupLogin" data-rel="popup" data-position-to="window" data-role="button" data-inline="true" aria-haspopup="true" aria-owns="popupLogin" aria-expanded="false" class="ui-link ui-btn ui-btn-inline ui-shadow ui-corner-all" role="button">点击登录</a>
        </div>
        <!--登录弹窗start-->
        <div data-role="popup" id="popupLogin" data-theme="a" class="ui-corner-all">
        <form>
            <div style="padding:10px 20px;">
                <h3>请登录</h3>
                <label for="un" class="ui-hidden-accessible">用户名:</label>
                <input type="text" name="username" id="un" value="" placeholder="用户名" data-theme="a">
                <label for="pw" class="ui-hidden-accessible">密码:</label>
                <input type="password" name="pass" id="pw" value="" placeholder="密码" data-theme="a">
                <button type="button" onClick="check_login_personal(1);" class="ui-btn ui-corner-all ui-shadow ui-btn-b ui-btn-icon-left ui-icon-check">登录</button>
            </div>
        </form>
        </div>
        <!--登录弹窗end-->
    	<script>
		//DEBUG jqm ajax 切换需初始化弹窗
		$(function(){
			check_login_personal(0);
		});
		
		function check_login_personal(pop_id){
			var check_login_result = check_login();
			if(1==check_login_result){
				var userinfo=JSON.parse(localStorage.getItem("userinfo"));
				$('#user_realname').val(userinfo.userinfo.user_realname);
				$('#user_score').val(userinfo.userinfo.user_score);
				$('#user_panel').show();
				$('#user_popuplogin').hide();
				if(pop_id){
					$("#popupLogin").popup("close");
				}
			}
			if(2==check_login_result){
				$('#user_panel').hide();
				$('#user_popuplogin').show();
			}
		}
		
		function transfer_score(){
			var transfer_user_name = $('#transfer_user_name').val();
			if(!transfer_user_name){
				alert('转移对象用户名不能为空');
			}
			var transfer_user_score = $('#transfer_user_score').val();
			if(!transfer_user_score){
				alert('转移积分数名不能为空');
			}
			//执行转移
			if(transfer_user_name && transfer_user_score){
				var userinfo=JSON.parse(localStorage.getItem("userinfo"));
				loading_on('a','',true,false,'');
				$.ajax({
				  type: "POST",
				  async:false,
				  url: server_url+"index.php?mod=ajax&action=member&do=transfer_score&api_client=1&user_id="+userinfo.userinfo.user_id,
				  data: {"transfer_user_name":transfer_user_name,"transfer_user_score":transfer_user_score},
				  cache: false,
				  dataType: "JSON",
				  timeout: 5000,//单位毫秒
				  error: function(XMLHttpRequest, textStatus, errorThrown){ //TODO: 处理status， http status code，超时 408
					// 注意：如果发生了错误，错误信息（第二个参数）除了得到null之外，还可能
					//是"timeout", "error", "notmodified" 和 "parsererror"。
					loading_on('a','您未接入互联网',true,false,'');
				  }
				})
				.done(function( data ) {
					if(data){
						console.log(data);
						alert(data.error_msg);
						//loading_on('a',data.error_msg,true,false,'');
					}else{
						//loading_on('a','您未接入互联网',true,false,'');
					}
					//loading_off();
				});
				update_local_userinfo(userinfo.userinfo.user_id);
				check_login_personal(0);
			}
		}
        </script>
	</div>
  <!-- /content --> 

</div>
<!-- /page -->

<div data-role="footer" data-position="fixed" data-tap-toggle="true" data-theme="a">
  <div data-role="navbar">
    <ul>
      <li><a href="index.html" data-prefetch="true" data-transition="none" data-icon="home">首页</a></li>
      <li><a href="content.html" data-prefetch="true" data-transition="slide" data-icon="tag">温故知新</a></li>
	  <li><a href="beishu.html" data-prefetch="true" data-transition="slide" data-icon="tag">背书练习</a></li>
      <li><a href="personal.html" data-prefetch="true" data-transition="slide" data-icon="gear">我的信息</a></li>
    </ul>
  </div>
  <!-- /navbar --> 
</div>
<!-- /footer -->
</body>
</html>